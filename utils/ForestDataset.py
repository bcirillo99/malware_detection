import numpy as np
import tarfile
from ember.features import PEFeatureExtractor

def load_forest_dataset(dataset_path,first_n_byte,set):
    file_list=list()
    label_list=list()
    with tarfile.open(dataset_path,'r') as tar:
        for file in tar.getmembers():
            if file.isfile():
                name_splitted=file.name.split('/')
                train_or_test=name_splitted[-3]
                malware_type=name_splitted[-2]
                if set==train_or_test:
                    file_extracted = tar.extractfile(file)
                    print('Extracting {}'.format(file.name))
                    bytes = file_extracted.read()
                    features=get_ember_features(bytes)
                    # tmp = [i for i in file_extracted.read()[:first_n_byte]]
                    # tmp = tmp+[256]*(first_n_byte-len(tmp))
                    file_list.append(features)
                    if malware_type=="benign":
                        label_list.append(0)
                    else:
                        label_list.append(1)
    return np.array(file_list), np.array(label_list)

#Extract a feature vector from a binary file using the ember Feature Extractor

def get_ember_features(bytes, dst=None):
    extractor = PEFeatureExtractor()
    features = [float(value) for value in extractor.feature_vector(bytes)]
    return features